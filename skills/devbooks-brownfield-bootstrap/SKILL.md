---
name: devbooks-brownfield-bootstrap
description: "devbooks-brownfield-bootstrap: Brownfield project initialization. When the truth directory is empty, generate project profile, glossary, baseline specs, and minimum verification anchors to avoid 'patching specs while changing behavior'. Use when user says 'brownfield init/baseline specs/project profile/establish glossary/onboard legacy project to context protocol' etc."
tools:
  - Glob
  - Grep
  - Read
  - Write
  - Edit
  - Bash
  - mcp__ckb__getStatus
  - mcp__ckb__getArchitecture
  - mcp__ckb__getHotspots
  - mcp__ckb__listKeyConcepts
  - mcp__ckb__getModuleOverview
---

# DevBooks: Brownfield Bootstrap

## Prerequisites: Configuration Discovery (Protocol Agnostic)

- `<truth-root>`: Current truth directory root
- `<change-root>`: Change package directory root
- `<devbooks-root>`: DevBooks management directory (usually `dev-playbooks/`)

Before execution, **must** search for configuration in the following order (stop when found):
1. `.devbooks/config.yaml` (if exists) → Parse and use its mappings
2. `dev-playbooks/project.md` (if exists) → DevBooks 2.0 protocol, use default mappings
3. `project.md` (if exists) → Template protocol, use default mappings
5. If still unable to determine → **Create DevBooks directory structure and initialize basic configuration**

**Key Constraints**:
- If configuration specifies `agents_doc` (rules document), **must read that document first** before executing any operations
- Do not guess directory roots
- Do not skip reading rules document

---

## Core Responsibilities

Brownfield project initialization includes the following responsibilities:

### 1. Basic Configuration File Initialization

Check and create in `<devbooks-root>/` (usually `dev-playbooks/`):

| File | Purpose | Creation Condition |
|------|---------|-------------------|
| `constitution.md` | Project constitution (GIP principles) | When file doesn't exist |
| `project.md` | Project context (tech stack/conventions) | When file doesn't exist |

**Creation Method**:
- **Not simple template copying**, but customized content based on code analysis results
- `constitution.md`: Based on default GIP principles, can be adjusted according to project characteristics
- `project.md`: Filled based on code analysis results:
  - Tech stack (language/framework/database)
  - Development conventions (code style/testing strategy/Git workflow)
  - Domain context (core concepts/role definitions)
  - Directory root mappings

### 2. Project Profile and Metadata

Generate in `<truth-root>/_meta/`:

| Artifact | Path | Description |
|----------|------|-------------|
| Project profile | `_meta/project-profile.md` | Detailed technical profile with three-layer architecture |
| Glossary | `_meta/glossary.md` | Unified language table (optional but recommended) |
| Domain concepts | `_meta/key-concepts.md` | Concepts extracted by CKB (enhanced mode) |

### 3. Architecture Analysis Artifacts

Generate in `<truth-root>/architecture/`:

| Artifact | Path | Data Source |
|----------|------|-------------|
| **C4 Architecture Map** | `architecture/c4.md` | Comprehensive analysis + CKB (enhanced mode) |
| Module dependency graph | `architecture/module-graph.md` | `mcp__ckb__getArchitecture` |
| Technical debt hotspots | `architecture/hotspots.md` | `mcp__ckb__getHotspots` |
| Layering constraints | `architecture/layering-constraints.md` | Code analysis (optional) |

> **Design Decision**: C4 architecture map is now generated by brownfield-bootstrap during initialization. Subsequent architecture changes are recorded in design.md's Architecture Impact section and merged by spec-gardener during archiving.

### 4. Baseline Change Package

Generate in `<change-root>/<baseline-id>/`:

| Artifact | Description |
|----------|-------------|
| `proposal.md` | Baseline scope, In/Out, risks |
| `design.md` | Current state inventory (capability inventory) |
| `specs/<cap>/spec.md` | Baseline spec deltas (mainly ADDED) |
| `verification.md` | Minimum verification anchor plan |

---

## COD Model Generation (Code Overview & Dependencies)

Automatically generate project's "code map" during initialization (requires CKB MCP Server available, otherwise skip):

### Auto-generated Artifacts

| Artifact | Path | Data Source |
|----------|------|-------------|
| **C4 Architecture Map** | `<truth-root>/architecture/c4.md` | Comprehensive analysis |
| Module dependency graph | `<truth-root>/architecture/module-graph.md` | `mcp__ckb__getArchitecture` |
| Technical debt hotspots | `<truth-root>/architecture/hotspots.md` | `mcp__ckb__getHotspots` |
| Domain concepts | `<truth-root>/_meta/key-concepts.md` | `mcp__ckb__listKeyConcepts` |
| Project profile | `<truth-root>/_meta/project-profile.md` | Comprehensive analysis |

### C4 Architecture Map Generation Rules

C4 map generated during initialization should include:

1. **Context Level**: System's relationship with external actors (users, external systems)
2. **Container Level**: Containers within the system (applications, databases, services)
3. **Component Level**: Components within main containers (modules, classes)

**Output Format**:

```markdown
# C4 Architecture Map

## System Context

[Describe system boundaries and external interactions]

## Container Diagram

| Container | Tech Stack | Responsibility |
|-----------|------------|----------------|
| <name> | <tech> | <responsibility> |

## Component Diagram

### <Container Name>

| Component | Responsibility | Dependencies |
|-----------|----------------|--------------|
| <name> | <responsibility> | <dependencies> |

## Architecture Guardrails

### Layering Constraints

| Layer | Can Depend On | Cannot Depend On |
|-------|---------------|------------------|
| <layer> | <allowed> | <forbidden> |
```

### Hotspot Calculation Formula

```
Hotspot Score = Change Frequency × Cyclomatic Complexity
```

- **High Hotspot** (score > threshold): Frequent changes + high complexity = Bug-dense area
- **Dormant Debt** (high complexity + low frequency): Temporarily safe but needs attention
- **Active Healthy** (high frequency + low complexity): Normal maintenance area

### Boundary Identification

Automatically distinguish:
- **User Code**: `src/`, `lib/`, `app/` etc. (modifiable)
- **Library Code**: `node_modules/`, `vendor/`, `.venv/` etc. (immutable interface)
- **Generated Code**: `dist/`, `build/`, `*.generated.*` etc. (manual modification prohibited)

### Execution Flow

1) **Check Graph Index**: Call `mcp__ckb__getStatus`
   - If SCIP available → Use graph-based analysis
   - If unavailable → Prompt to generate index or use Git history analysis

2) **Generate COD Artifacts**:
   ```bash
   # Get module architecture
   mcp__ckb__getArchitecture(depth=2, includeExternalDeps=false)

   # Get hotspots (last 30 days)
   mcp__ckb__getHotspots(limit=20)

   # Get domain concepts
   mcp__ckb__listKeyConcepts(limit=12)
   ```

3) **Generate Project Profile**: Integrate above data + traditional analysis

## Reference Scaffolds and Templates

- Workflow: `references/brownfield-bootstrap.md`
- Code navigation strategy: `references/code-navigation-strategy.md`
- **Project profile template (three-layer architecture)**: `templates/project-profile-template.md`
- One-time prompt: `references/brownfield-bootstrap-prompt.md`
- Template (as needed): `references/glossary-template.md`

---

## Context Awareness

This Skill automatically detects context before execution and selects the appropriate initialization scope.

Detection rules reference: `skills/_shared/context-detection-template.md`

### Detection Flow

1. Detect if `<devbooks-root>/constitution.md` exists
2. Detect if `<devbooks-root>/project.md` exists
3. Detect if `<truth-root>/` is empty or basically empty
4. Detect if CKB index is available
5. Detect project scale and language stack

### Modes Supported by This Skill

| Mode | Trigger Condition | Behavior |
|------|-------------------|----------|
| **Full New Init** | devbooks-root doesn't exist or is empty | Create complete directory structure + constitution + project + profile |
| **Supplement Config** | constitution/project missing | Only supplement missing configuration files |
| **Complete Init** | truth-root is empty | Generate all basic artifacts (profile/baseline/verification) |
| **Incremental Init** | truth-root partially exists | Only supplement missing artifacts |
| **Enhanced Mode** | CKB index available | Use graph analysis to generate more precise profile |
| **Basic Mode** | CKB index unavailable | Use traditional analysis methods |

### Detection Output Example

```
Detection Results:
- devbooks-root: Exists
- constitution.md: Doesn't exist → Will create
- project.md: Doesn't exist → Will create
- truth-root: Empty
- CKB index: Available
- Project scale: Medium (~50K LOC)
- Running mode: Supplement Config + Complete Init + Enhanced Mode
```

---

## MCP Enhancement

This Skill supports MCP runtime enhancement, automatically detecting and enabling advanced features.

MCP enhancement rules reference: `skills/_shared/mcp-enhancement-template.md`

### Required MCP Services

| Service | Purpose | Timeout |
|---------|---------|---------|
| `mcp__ckb__getStatus` | Detect CKB index availability | 2s |
| `mcp__ckb__getArchitecture` | Get module dependency graph | 2s |
| `mcp__ckb__getHotspots` | Get technical debt hotspots | 2s |
| `mcp__ckb__listKeyConcepts` | Get domain concepts | 2s |
| `mcp__ckb__getModuleOverview` | Get module overview | 2s |

### Detection Flow

1. Call `mcp__ckb__getStatus` (2s timeout)
2. If CKB available → Use graph-based analysis to generate COD artifacts
3. If timeout or failure → Degrade to traditional analysis (Git history + file statistics)

### Enhanced Mode vs Basic Mode

| Feature | Enhanced Mode | Basic Mode |
|---------|---------------|------------|
| Module dependency graph | CKB getArchitecture | Directory structure inference |
| Technical debt hotspots | CKB getHotspots | Git log statistics |
| Domain concepts | CKB listKeyConcepts | Naming analysis |
| Boundary identification | Precise module boundaries | Directory conventions |

### Degradation Notice

When MCP is unavailable, output the following notice:

```
Warning: CKB unavailable, using traditional analysis methods to generate project profile.
For more precise architecture analysis, manually generate SCIP index.
```
